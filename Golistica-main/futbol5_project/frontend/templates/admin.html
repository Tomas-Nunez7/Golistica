<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Panel Admin - Golística</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet" />
</head>
<body class="bg-gray-100 min-h-screen flex flex-col">
    <nav class="bg-gray-900 text-white px-6 py-4 flex justify-between items-center">
        <div class="font-bold text-lg">Golística - Panel de Administración</div>
        <div class="space-x-4 text-sm">
            <span id="admin-username" class="opacity-80"></span>
            <a href="dashboard.html" class="hover:underline">Volver al dashboard</a>
            <button id="logout-btn" class="bg-red-600 hover:bg-red-700 px-3 py-1 rounded text-xs">Cerrar sesión</button>
        </div>
    </nav>

    <main class="flex-1 container mx-auto px-4 py-6 space-y-8">
        <section>
            <h2 class="text-xl font-semibold mb-3">Verificación de Integridad</h2>
            <div class="flex space-x-2 mb-3">
                <button id="btn-check-integrity" class="px-3 py-2 bg-blue-600 text-white text-sm rounded hover:bg-blue-700">Ejecutar chequeo</button>
                <button id="btn-fix-integrity" class="px-3 py-2 bg-yellow-600 text-white text-sm rounded hover:bg-yellow-700">Aplicar rectificación</button>
            </div>
            <div id="integrity-result" class="text-sm bg-white rounded shadow p-3 max-h-64 overflow-auto"></div>
        </section>

        <section>
            <h2 class="text-xl font-semibold mb-3">Estadísticas de Reservas por Usuario</h2>
            <button id="btn-load-stats" class="px-3 py-2 bg-green-600 text-white text-sm rounded hover:bg-green-700 mb-3">Cargar estadísticas</button>
            <table class="min-w-full bg-white rounded shadow text-sm">
                <thead>
                    <tr class="bg-gray-100 text-left">
                        <th class="px-3 py-2">User ID</th>
                        <th class="px-3 py-2">Total Reservas</th>
                        <th class="px-3 py-2">Última actualización</th>
                    </tr>
                </thead>
                <tbody id="stats-body"></tbody>
            </table>
        </section>

        <section class="grid md:grid-cols-2 gap-6">
            <div>
                <h2 class="text-xl font-semibold mb-3">Bitácora (Audit Log)</h2>
                <button id="btn-load-audit" class="px-3 py-2 bg-indigo-600 text-white text-sm rounded hover:bg-indigo-700 mb-3">Cargar últimas entradas</button>
                <div id="audit-log" class="text-xs bg-white rounded shadow p-3 max-h-64 overflow-auto"></div>
            </div>
            <div>
                <h2 class="text-xl font-semibold mb-3">Alertas Críticas</h2>
                <button id="btn-load-alerts" class="px-3 py-2 bg-red-600 text-white text-sm rounded hover:bg-red-700 mb-3">Cargar alertas</button>
                <div id="alerts-log" class="text-xs bg-white rounded shadow p-3 max-h-64 overflow-auto"></div>
            </div>
        </section>
    </main>

    <script>
        function getToken() {
            return localStorage.getItem('golistica_token');
        }

        async function ensureAdmin() {
            const token = getToken();
            if (!token) {
                window.location.href = 'login.html';
                return null;
            }
            try {
                const resp = await fetch('http://localhost:8000/api/me', {
                    headers: { 'Authorization': `Bearer ${token}` },
                });
                if (!resp.ok) {
                    window.location.href = 'login.html';
                    return null;
                }
                const user = await resp.json();
                if (user.role_id !== 3) {
                    alert('Acceso restringido a administradores.');
                    window.location.href = 'dashboard.html';
                    return null;
                }
                return user;
            } catch (err) {
                console.error('Error llamando a /api/me', err);
                window.location.href = 'login.html';
                return null;
            }
        }

        async function adminFetch(path, options = {}) {
            const token = getToken();
            const headers = Object.assign({}, options.headers || {}, {
                'Authorization': `Bearer ${token}`,
                'Content-Type': options.body ? 'application/json' : (options.headers || {})['Content-Type'] || undefined,
            });
            if (!headers['Content-Type']) delete headers['Content-Type'];
            const resp = await fetch(`http://localhost:8000${path}`, Object.assign({}, options, { headers }));
            return resp;
        }

        document.addEventListener('DOMContentLoaded', async () => {
            const user = await ensureAdmin();
            if (!user) return;

            document.getElementById('admin-username').textContent = `Admin: ${user.username}`;

            document.getElementById('logout-btn').addEventListener('click', () => {
                localStorage.removeItem('golistica_token');
                window.location.href = 'index.html';
            });

            // Integridad
            document.getElementById('btn-check-integrity').addEventListener('click', async () => {
                const box = document.getElementById('integrity-result');
                box.textContent = 'Ejecutando chequeo...';
                try {
                    const resp = await adminFetch('/api/admin/integrity/check', { method: 'POST' });
                    const data = await resp.json();
                    box.textContent = JSON.stringify(data, null, 2);
                } catch (err) {
                    console.error('Error en integrity/check', err);
                    box.textContent = 'Error al ejecutar el chequeo.';
                }
            });

            document.getElementById('btn-fix-integrity').addEventListener('click', async () => {
                const box = document.getElementById('integrity-result');
                box.textContent = 'Aplicando rectificación...';
                try {
                    const resp = await adminFetch('/api/admin/integrity/fix', { method: 'POST' });
                    const data = await resp.json();
                    box.textContent = JSON.stringify(data, null, 2);
                } catch (err) {
                    console.error('Error en integrity/fix', err);
                    box.textContent = 'Error al aplicar rectificación.';
                }
            });

            // Stats
            document.getElementById('btn-load-stats').addEventListener('click', async () => {
                const tbody = document.getElementById('stats-body');
                tbody.innerHTML = '';
                try {
                    const resp = await adminFetch('/api/admin/stats/users/reservations');
                    const data = await resp.json();
                    tbody.innerHTML = data.map(row => `
                        <tr class="border-t">
                            <td class="px-3 py-2">${row.user_id}</td>
                            <td class="px-3 py-2">${row.total_reservations}</td>
                            <td class="px-3 py-2 text-xs">${row.last_updated || ''}</td>
                        </tr>
                    `).join('');
                } catch (err) {
                    console.error('Error cargando stats', err);
                }
            });

            // Audit log
            document.getElementById('btn-load-audit').addEventListener('click', async () => {
                const box = document.getElementById('audit-log');
                box.textContent = 'Cargando...';
                try {
                    const resp = await adminFetch('/api/admin/audit_log?limit=50');
                    const data = await resp.json();
                    box.textContent = JSON.stringify(data, null, 2);
                } catch (err) {
                    console.error('Error cargando audit log', err);
                    box.textContent = 'Error al cargar bitácora.';
                }
            });

            // Alerts
            document.getElementById('btn-load-alerts').addEventListener('click', async () => {
                const box = document.getElementById('alerts-log');
                box.textContent = 'Cargando...';
                try {
                    const resp = await adminFetch('/api/admin/alerts?limit=50');
                    const data = await resp.json();
                    box.textContent = JSON.stringify(data, null, 2);
                } catch (err) {
                    console.error('Error cargando alerts', err);
                    box.textContent = 'Error al cargar alertas.';
                }
            });
        });
    </script>
</body>
</html>
